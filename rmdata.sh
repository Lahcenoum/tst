#!/bin/bash

# ========================================================================
#  ุณูุฑูุจุช ูุฅุนุงุฏุฉ ุถุจุท ุจูุช SSH ุจุงููุงูู
#  - ูุญุฐู ุฌููุน ุญุณุงุจุงุช SSH ุงูุชู ุฃูุดุฃูุง ุงูุจูุช
#  - ูุญุฐู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุนูุฏ ุฌููุน ุงููุณุชุฎุฏููู ุฅูู ููุทุฉ ุงูุตูุฑ
# ========================================================================

# --- ุฅุนุฏุงุฏุงุช ---
# ุงูุจุงุฏุฆุฉ ุงูุฎุงุตุฉ ุจุฃุณูุงุก ุงููุณุชุฎุฏููู ุงูุฐูู ุณูุชู ุญุฐููู
USER_PREFIX="sshdatbot"
# ุงููุณุงุฑ ุฅูู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
DB_FILE="/home/ssh_bot/ssh_bot_users.db"
# ุงุณู ุฎุฏูุฉ ุงูุจูุช
SERVICE_NAME="ssh_bot.service"

# --- ุจุฏุงูุฉ ุงูุณูุฑูุจุช ---

echo "โ๏ธ ุชุญุฐูุฑ: ูุฐุง ุงูุณูุฑูุจุช ุณูููู ุจุญุฐู ุฌููุน ุญุณุงุจุงุช SSH ุงูุชู ุฃูุดุฃูุง ุงูุจูุช ููุงุนุฏุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู ุจุงููุงูู."
read -p "ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ (ุงูุชุจ 'ูุนู' ููุชุฃููุฏ): " CONFIRMATION

if [ "$CONFIRMATION" != "ูุนู" ]; then
    echo "ุชู ุฅูุบุงุก ุงูุนูููุฉ."
    exit 0
fi

echo "----------------------------------------"

# 1. ุฅููุงู ุฎุฏูุฉ ุงูุจูุช
echo "๐ [1/4] ุฌุงุฑู ุฅููุงู ุฎุฏูุฉ ุงูุจูุช..."
systemctl stop "$SERVICE_NAME"

# 2. ุญุฐู ุฌููุน ุญุณุงุจุงุช SSH ุงูุชู ุฃูุดุฃูุง ุงูุจูุช
echo "๐ฅ [2/4] ุฌุงุฑู ุญุฐู ุฌููุน ุญุณุงุจุงุช SSH ุงูุชู ุชุจุฏุฃ ุจู '$USER_PREFIX'..."
for USERNAME in $(getent passwd | cut -d: -f1 | grep "^$USER_PREFIX"); do
    echo "   - ุญุฐู ุงููุณุชุฎุฏู: $USERNAME"
    userdel -r "$USERNAME"
done
echo "โ ุชู ุญุฐู ุญุณุงุจุงุช SSH ุจูุฌุงุญ."

# 3. ุญุฐู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
echo "๐๏ธ [3/4] ุฌุงุฑู ุญุฐู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
if [ -f "$DB_FILE" ]; then
    rm -f "$DB_FILE"
    echo "โ ุชู ุญุฐู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ."
else
    echo "โน๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฑุจูุง ุชู ุญุฐูู ูุณุจููุง)."
fi

# 4. ุฅุนุงุฏุฉ ุชุดุบูู ุฎุฏูุฉ ุงูุจูุช
echo "๐ [4/4] ุฌุงุฑู ุฅุนุงุฏุฉ ุชุดุบูู ุฎุฏูุฉ ุงูุจูุช..."
systemctl start "$SERVICE_NAME"
sleep 3 # ุงูุชุธุฑ ููููุงู ููุชุฃูุฏ ูู ุฃู ุงูุฎุฏูุฉ ุจุฏุฃุช

if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "๐ ุงูุชููุช ุนูููุฉ ุฅุนุงุฏุฉ ุงูุถุจุท ุจูุฌุงุญ! ุงูุจูุช ูุนูู ุงูุขู ุจูุงุนุฏุฉ ุจูุงูุงุช ูุธููุฉ."
else
    echo "โ ูุดูุช ุนูููุฉ ุฅุนุงุฏุฉ ุงูุถุจุท. ูุฑุฌู ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุฏูุฉ ูุฏูููุง ุจุงุณุชุฎุฏุงู: systemctl status $SERVICE_NAME"
fi

echo "----------------------------------------"
